syntax = "proto3";
package user;
option go_package = "user-service/pkg/userpb";

service UserService {
  // Вызывается из Auth-сервиса при регистрации
  rpc CreateProfile (CreateProfileRequest) returns (CreateProfileResponse);
  
  // Методы для фронтенда   
  rpc GetProfile (GetProfileRequest) returns (GetProfileResponse);
  rpc UpdateProfile (UpdateProfileRequest) returns (UpdateProfileResponse);
  rpc SetAvatar (SetAvatarRequest) returns (SetAvatarResponse);
  
  // Если email меняется в Auth, обновляем его и здесь (для уведомлений)
  rpc SyncEmail (SyncEmailRequest) returns (SyncEmailResponse);

  rpc StartCourse(StartCourseRequest) returns (StartCourseResponse);
  rpc UpdateProgress(UpdateProgressRequest) returns (UpdateProgressResponse);

  rpc CompleteLesson(CompleteLessonRequest) returns (CompleteLessonResponse);
  rpc GetCompletedLessons(GetCompletedLessonsRequest) returns (GetCompletedLessonsResponse);

  rpc SetSubscription (SetSubscriptionRequest) returns (SetSubscriptionResponse);

  rpc AddCourseLimit(AddCourseLimitRequest) returns (AddCourseLimitResponse);
  
  // Изменить баланс (начислить или списать снежинки)
  rpc ChangeBalance(ChangeBalanceRequest) returns (ChangeBalanceResponse);
  
  // Разблокировать аватарку (выпала в колесе)
  rpc UnlockAvatar(UnlockAvatarRequest) returns (UnlockAvatarResponse);
  
  // Получить топ студентов
  rpc GetLeaderboard(GetLeaderboardRequest) returns (GetLeaderboardResponse);
}

message CreateProfileRequest {
  string user_id = 1;
  string email = 2;
  string username = 3;
}

message CreateProfileResponse {
  string profile_id = 1;
}

message GetProfileRequest {
  string user_id = 1;
}

message CoursePreview {
  string id = 1;
  string title = 2;
  int32 progress_percent = 3;
  string cover_url = 4;
}

message GetProfileResponse {
  string id = 1;
  string email = 2;
  string username = 3;
    // Данные о подписке для фронта
    string subscription_status = 4; 
    int32 course_limit = 5;
    int32 courses_used = 6;
    int32 device_limit = 7;
    int64 expires_at = 8;
    bool tg_access = 9;
  int32 avatar_id = 10;
  repeated CoursePreview active_courses = 11;
  repeated CoursePreview completed_courses = 12;
  
  

  int32 streak = 13;               // Текущая серия дней (например, 5)
  bool is_streak_active_today = 14; // true = огонек горит (уже позанимался сегодня), false = серый (позанимался вчера)

  int32 balance = 15; // Снежинки
  repeated int32 unlocked_avatar_ids = 16; // Список ID доступных аватарок

  int32 rank = 17; // Место пользователя в рейтинге
}

message UpdateProfileRequest {
  string user_id = 1;
  string username = 2; // Email меняем через Auth сервис
}

message UpdateProfileResponse {
  bool success = 1;
}

message SetAvatarRequest {
  string user_id = 1;
  int32 avatar_id = 2;
}

message SetAvatarResponse {
  bool success = 1;
  int32 avatar_id = 2;
}

message SyncEmailRequest {
  string user_id = 1;
  string new_email = 2;
}

message SyncEmailResponse {
  bool success = 1;
}

    
message StartCourseRequest {
  string user_id = 1;
  string course_id = 2;
  string title = 3;      // Приходит с фронта или от Gateway
  string cover_url = 4;
}

message StartCourseResponse {
  bool success = 1;
}

message UpdateProgressRequest {
  string user_id = 1;
  string course_id = 2;
  int32 progress_percent = 3;
}

message UpdateProgressResponse {
  bool success = 1;
  string status = 2; // Возвращаем новый статус ("completed" если 100%)
}

message CompleteLessonRequest {
  string user_id = 1;
  string course_id = 2;
  string lesson_id = 3;
  int32 total_lessons = 4; // Фронт или Gateway сообщит общее кол-во, чтобы пересчитать %
}

message CompleteLessonResponse {
  bool success = 1;
  int32 new_percent = 2; // Возвращаем новый процент
  string status = 3;     // Возвращаем новый статус (active/completed)
}

message GetCompletedLessonsRequest {
  string user_id = 1;
  string course_id = 2;
}

message GetCompletedLessonsResponse {
  repeated string lesson_ids = 1;
}

message SetSubscriptionRequest {
  string user_id = 1;
  string plan_name = 2;    // Название тарифа для отображения
  int32 course_limit = 3;  // Сколько курсов можно взять (-1 = много)
  int32 device_limit = 4;  // Сколько устройств
  bool tg_access = 5;      // Доступ к ТГ
  int64 expires_at = 6;    // Когда истекает (Unix timestamp)
}

message SetSubscriptionResponse {
  bool success = 1;
}
message AddCourseLimitRequest {
  string user_id = 1;
  int32 count = 2;
}
message AddCourseLimitResponse {
  bool success = 1;
  int32 new_limit = 2;
}
message ChangeBalanceRequest {
  string user_id = 1;
  int32 amount = 2; // Положительное = начислить, Отрицательное = списать
}
message ChangeBalanceResponse {
  bool success = 1;
  int32 new_balance = 2;
}

message UnlockAvatarRequest {
  string user_id = 1;
  int32 avatar_id = 2;
}
message UnlockAvatarResponse {
  bool success = 1;
  bool already_owned = 2;
}

message GetLeaderboardRequest {
  int32 limit = 1;
}
message LeaderboardEntry {
  string user_id = 1;
  string username = 2;
  int32 avatar_id = 3;
  int32 streak = 4;
  int32 completed_count = 5;
  int32 balance = 6;
}
message GetLeaderboardResponse {
  repeated LeaderboardEntry entries = 1;
}
